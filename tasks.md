# hledger-lsp: План разработки

## Статус проекта

**Фаза 1: Основа** — ✅ Завершена

| Компонент | Статус | Покрытие |
|-----------|--------|----------|
| Структура проекта | ✅ | - |
| Lexer | ✅ | 89.3% |
| Parser | ✅ | есть тесты |
| AST типы | ✅ | - |
| Базовый LSP сервер | ✅ | - |
| Синхронизация документов | ✅ | - |
| Базовая диагностика | ✅ | - |

---

## Фаза 2: Основные функции LSP

- [ ] **2.1 Analyzer модуль** — валидация баланса, семантический анализ
  - Создать `internal/analyzer/analyzer.go`
  - Проверка баланса транзакций
  - Сбор информации о счетах, плательщиках, валютах

- [ ] **2.2 Completion Provider** — автодополнение
  - Счета (из директив и использования)
  - Плательщики (payee из транзакций)
  - Валюты/commodities
  - Теги
  - Даты (сегодня, вчера, последние использованные)

- [ ] **2.3 Diagnostics Provider** — расширенная диагностика
  - Несбалансированные транзакции
  - Неизвестные счета (если есть директивы account)
  - Дублирующиеся транзакции (опционально)

- [ ] **2.4 Formatting Provider** — форматирование документов
  - Выравнивание сумм
  - Нормализация отступов
  - Сортировка постингов

- [ ] **2.5 Semantic Tokens** — подсветка синтаксиса
  - Даты, счета, суммы, комментарии
  - Директивы, статусы

---

## Фаза 3: Расширенные функции

- [ ] **3.1 Hover Provider** — информация при наведении
  - Баланс счёта
  - Итоги транзакции
  - Информация о валюте

- [ ] **3.2 Document Symbols** — структура документа
  - Список транзакций
  - Список директив
  - Навигация по датам

- [ ] **3.3 Include file resolution** — обработка include
  - Разрешение путей
  - Обнаружение циклов
  - Агрегация данных из всех файлов

- [ ] **3.4 Parser extensions** — расширение парсера
  - Virtual postings (скобки)
  - Теги из комментариев
  - Date2 (вторичная дата)
  - Price directive (P)

- [ ] **3.5 CLI Integration** — интеграция с hledger
  - Обёртка для вызова hledger
  - Получение отчётов
  - Fallback валидация

---

## Фаза 4: Тестирование

- [ ] **4.1 Server tests** — тесты LSP хендлеров
  - Initialize/Shutdown
  - TextDocumentSync
  - Completion requests
  - Diagnostics publishing

- [ ] **4.2 Benchmark tests** — производительность
  - Парсинг больших файлов
  - Инкрементальные обновления
  - Время отклика completion

- [ ] **4.3 Integration tests** — интеграционные тесты
  - Полные LSP request/response циклы
  - Тесты с реальными редакторами (опционально)

---

## Фаза 5: Финализация

- [ ] **5.1 Code review** — ревью кода
- [ ] **5.2 CI/CD pipeline** — автоматизация сборки и релизов
- [ ] **5.3 Документация для редакторов** — VS Code, Neovim, Emacs

---

## Порядок выполнения

```
Analyzer (2.1)
     │
     ▼
┌────┴────┬────────┬────────┬────────┐
│         │        │        │        │
▼         ▼        ▼        ▼        ▼
2.2      2.3      2.4      2.5      3.x
Completion Diagnostics Formatting Semantic
     │         │        │        │
     └────┬────┴────────┴────────┘
          │
          ▼
    Тестирование (4.x)
          │
          ▼
    Финализация (5.x)
```

**Критический путь**: 2.1 → (2.2-2.5 параллельно) → 4.x → 5.x
